<app-navbar></app-navbar>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <app-loader></app-loader>
</div>

<!-- Error State -->
<div *ngIf="error && !isLoading" class="error-container">
  <div class="error-content">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    <h2>Error Loading Article</h2>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="ngOnInit()">Try Again</button>
  </div>
</div>

<!-- Main Article Content -->
<main class="article-container" *ngIf="!isLoading && !error && article">
  <article class="article-content">
    <!-- Article Header -->
    <header class="article-header">
      <div class="topic-badge">
        {{ capitalizeFirstLetter(article.topic) }}
      </div>
      
      <h1 class="article-title">{{ article.title }}</h1>
      
      <!-- Author Info -->
      <div class="author-section">
        <div class="author-info">
          <a [routerLink]="['/profile', article.userId]">
          <img 
            [src]="article.profilePic || getDefaultAvatar()" 
            [alt]="getFullName()" 
            class="author-avatar"
            (error)="$event.target.src = getDefaultAvatar()">
          </a>
            <div class="author-details">
              <a [routerLink]="['/profile', article.userId]" class="author-name">{{ getFullName() }}</a>
            <div class="article-meta">
              <span class="publish-date">{{ getFormattedDate(article.createdAt) }}</span>
              <span class="meta-separator">Â·</span>
              <span class="read-time">{{ getReadingTime(article.description) }} min read</span>
            </div>
          </div>
        </div>
        
        <button 
          class="report-btn" 
          [class.reported]="isReported"
          [disabled]="isReported"
          (click)="onReportArticle()" 
          type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
            <line x1="4" y1="22" x2="4" y2="15"></line>
          </svg>
          {{ isReported ? 'Reported' : 'Report' }}
        </button>
      </div>
    </header>

    <!-- Banner Image -->
  <section class="banner-section" *ngIf="article.banner">
      <img 
        [src]="article.banner" 
        [alt]="article.title" 
        class="banner-image"
        (error)="$event.target.src = getDefaultBanner()">
  </section>


    <!-- Article Content -->
    <section class="content-section">
      <div class="content-wrapper" [innerHTML]="article.description"></div>
    </section>

    <!-- Article Footer -->
    <footer class="article-footer">
      <div class="engagement-section">
        <button 
          class="engagement-btn like-btn" 
          [class.liked]="isLiked"
          (click)="onLikeArticle()" 
          type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" [attr.fill]="isLiked ? '#000000' : 'none'" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <span>{{ likesCount }}</span>
        </button>
        
        <button class="engagement-btn" (click)="onToggleComments()" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>{{ comments.length }}</span>
        </button>
      </div>
    </footer>

    <!-- Comments Section -->
    <section class="comments-section" [class.show]="showComments">
      <div class="comments-divider"></div>
      
      <div class="comments-container">
        <div class="comments-header">
          <h3>Responses ({{ comments.length }})</h3>
        </div>

        <!-- Add Comment Form -->
        <div class="add-comment-form">
          <div class="comment-input-container">
            <img 
              [src]="getCurrentUserAvatar()" 
              [alt]="getCurrentUserName()" 
              class="comment-avatar"
              (error)="$event.target.src = getDefaultAvatar()">
            <div class="comment-input-wrapper">
              <textarea 
                [(ngModel)]="newComment" 
                placeholder="Write a response..."
                class="comment-input"
                maxlength="200"
                [disabled]="isSubmittingComment"
                (input)="onCommentInputChange($event)"></textarea>
              <div class="character-count" [class.over-limit]="newComment.length > 200">
                {{ getCharacterCount() }}/200
              </div>
            </div>
          </div>
          
          <div class="comment-actions" *ngIf="newComment.trim().length > 0">
            <div class="comment-action-buttons">
              <button 
                class="cancel-btn" 
                (click)="onCancelComment()"
                [disabled]="isSubmittingComment"
                type="button">
                Cancel
              </button>
              <button 
                class="respond-btn" 
                (click)="onAddComment()" 
                [disabled]="!isCommentValid() || isSubmittingComment"
                type="button">
                <span *ngIf="!isSubmittingComment">Respond</span>
                <span *ngIf="isSubmittingComment">Posting...</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list" *ngIf="comments.length > 0">
          <div class="comment" *ngFor="let comment of comments; trackBy: trackByCommentId">
            <div class="comment-header">
              <img 
                [src]="comment.profilePic || getDefaultAvatar()" 
                [alt]="comment.firstName + ' ' + comment.lastName" 
                class="comment-avatar"
                (error)="$event.target.src = getDefaultAvatar()">
              <div class="wrapper">
              <div class="comment-info">
                <span class="comment-author">{{ comment.firstName }} {{ comment.lastName }}</span>
                <span class="comment-time">{{ getTimeAgo(comment.createdAt) }}</span>
              </div>

              <div class="delete-comment">
                <button 
                  class="delete-btn"
                 (click)="openDeleteDialog(comment.id)"
                  type="button">
                  <mat-icon fontSet="material-icons-outlined">delete</mat-icon>
                </button>
              </div>
              </div>

            </div>
            <div class="comment-content">
              <p>{{ comment.content }}</p>
            </div>
            <div class="comment-actions-row">
              <button 
                class="comment-action-btn" 
                [class.liked]="comment.isLiked"
                (click)="onLikeComment(comment)"
                type="button">
                <svg width="20" height="20" viewBox="0 0 24 24" [attr.fill]="comment.isLiked ? '#000000' : 'none'" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span>{{ comment.likeCount }}</span>
              </button>
              <button class="comment-action-btn" type="button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Reply
              </button>
            </div>
          </div>
        </div>

        <!-- No Comments State -->
        <div class="no-comments" *ngIf="comments.length === 0 && showComments">
          <div class="no-comments-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <p>No responses yet</p>
          <small>Be the first to respond</small>
        </div>
      </div>
    </section>
  </article>

  <!-- Report Popup -->
  <app-reportpopup 
    [postId]="selectedPostId"
    [title]="postTitle"
    [reportType]="'POST'"
    [isVisible]="showReportPopup"
    (onSubmit)="handleReportSubmit($event)"
    (onCancel)="handleReportCancel()">
  </app-reportpopup>
</main>